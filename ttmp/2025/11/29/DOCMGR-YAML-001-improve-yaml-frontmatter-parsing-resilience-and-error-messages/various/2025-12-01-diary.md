---
Title: Daily diary
Ticket: DOCMGR-YAML-001
Status: active
DocType: various
Intent: short-term
Topics:
  - yaml
  - ux
  - errors
Summary: Notes from implementing frontmatter validation fixes and smokes
LastUpdated: 2025-12-01
---

# Diary — 2025-12-01

## What I did
- Added taxonomy-driven `docmgr validate frontmatter` with `--suggest-fixes` and `--auto-fix`; fix generator handles missing delimiters, stray delimiter lines, trailing non-key lines, and quoting unsafe scalars; writes .bak before applying.
- Frontmatter parse context now carries `Fixes`; frontmatter rule renders them alongside snippets/actions.
- Extended writer/read paths to use preprocessing; improved splitter; exported `SplitFrontmatter` for fix generation.
- Extended smoke `18-validate-frontmatter-smoke.sh` to cover failure → suggest-fixes → auto-fix → success; reran scenarios 00-03, 15, 18 with `/tmp/docmgr-bin`.

## Issues/notes
- Auto-fix currently still emits the error taxonomy even when the run exits 0; need a polish pass to suppress/adjust messaging after successful fix.
- Need more unit tests around delimiter normalization, peeling trailing lines, and scrub logic.
- Diagnostics smoke (15) still doesn’t exercise new validation path; should be expanded.
- Docs not yet updated for new flags/behavior.

## Next actions
- Add unit tests for fix generator paths and auto-fix success/failure.
- Polish output after auto-fix (no error taxonomy on success).
- Expand diagnostics smoke and update docs (diagnostics/rules page, CLI guides).

## What I learned
- Taxonomy+rule plumbing makes CLI output consistent and lets us hang fix suggestions on contexts; adding `Fixes` to the frontmatter parse context was enough for rules to render suggestions without special CLI printing.
- Auto-fix flows must be careful about messaging: even when we fix and exit 0, emitting the original error taxonomy confuses users—need a post-fix success path.
- Frontmatter corruption shows up in multiple forms (missing closing delimiter, stray delimiter lines, plain text inside YAML). A small set of heuristics (delimiter normalization, peeling non-key lines, quoting unsafe scalars) covers most cases.
- Smoke scripts should use absolute doc paths to avoid cwd issues, and need explicit chmod to run in CI-like environments.

## Earlier work recap
- Position-aware parsing: replaced adrg/frontmatter-only flow with manual YAML extraction + `yaml.Node` to capture line/snippet/problem classification; wired taxonomies so doctor/list/search/meta/relate/import get richer context.
- Quoting/preprocessing: added `pkg/frontmatter` helpers (`NeedsQuoting`, `QuoteValue`, `PreprocessYAML`) and reused them in read/write paths; added unit coverage.
- Validation verb: introduced `validate` group with `frontmatter` subcommand, wired into Cobra tree, and updated diagnostics rule actions to point to it.
- Diagnostics/rules: frontmatter/listing rules now render suggested fixes and direct users to the new verb; actions kept consistent across commands.
